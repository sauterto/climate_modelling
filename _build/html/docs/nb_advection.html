
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Advection diffusion equation &#8212; Climate Modelling and Data Analysis</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Climate Modelling and Data Analysis</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../welcome.html">
                    Welcome to the Climate Modelling and Data Analysis Course
                </a>
            </li>
        </ul>
        <ul class="nav bd-sidenav">
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="intro_to_python.html">
   Lesson 0 -Introduction to Python
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="nb_python_exercises.html">
     Python exercises
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="analytical_models.html">
   Lesson 1 - Global Energy Balance Model
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="ebm_model.html">
     Simplified Energy Balance Model
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="nonlinearity.html">
     Nonlinearity, Feedbacks and Predictability
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="greenhouse_model.html">
     Greenhouse Model
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="numerical_models.html">
   Lesson 2 - Numerical Models
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="fluid_dynamics.html">
     Fluid dynamics
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="heat_equation.html">
     Heat Equation
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="advection.html">
     Advection-Diffusion
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="seb.html">
     Surface Energy Balance model
    </a>
   </li>
  </ul>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://mybinder.org/v2/gh/sauterto/climate_modelling/main?urlpath=tree/./docs/nb_advection.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Binder"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../_static/images/logo_binder.svg">
  </span>
<span class="headerbtn__text-container">Binder</span>
</a>

      </li>
      
      <li>
        <a href="https://colab.research.google.com/github/sauterto/climate_modelling/blob/main/./docs/nb_advection.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Colab"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../_static/images/logo_colab.png">
  </span>
<span class="headerbtn__text-container">Colab</span>
</a>

      </li>
      
      <li>
        
<button onclick="initThebeSBT()"
  class="headerbtn headerbtn-launch-thebe"
  data-toggle="tooltip"
data-placement="left"
title="Launch Thebe"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="headerbtn__text-container">Live Code</span>
</button>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/sauterto/climate_modelling"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/sauterto/climate_modelling/issues/new?title=Issue%20on%20page%20%2Fdocs/nb_advection.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../_sources/docs/nb_advection.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Advection diffusion equation</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section id="advection-diffusion-equation">
<h1>Advection diffusion equation<a class="headerlink" href="#advection-diffusion-equation" title="Permalink to this headline">#</a></h1>
<p><strong>Task 4</strong>: Solve the Advection-Diffusion equation, with the following initial and boundary conditions: at t=0 , 𝑐<span class="math notranslate nohighlight">\(_0\)</span>=0; for all subsequent times, 𝑐=0 at x=0, 𝑐=1 at 𝑥=𝐿=1, 𝑢=1.0 and K=0.1. Integrate over 0.05 s with a Δ𝑡=0.0028, and 40 grid points. Plot the results and the dimensionless time scales. Increase gradually Δ𝑡 and analyse the results. Once you understand what is happening, set again Δ𝑡=0.0028 and gradually increase the wind speed. Discuss the results.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">math</span>

<span class="o">%</span><span class="k">matplotlib</span> inline


<span class="k">def</span> <span class="nf">advection_diffusion</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">integration</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">Nx</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Simple advection-diffusion equation.</span>
<span class="sd">    </span>
<span class="sd">    integration :: Integration time in seconds</span>
<span class="sd">    Nx          :: Number of grid points</span>
<span class="sd">    dt          :: time step in seconds</span>
<span class="sd">    K           :: turbulent diffusivity</span>
<span class="sd">    u           :: Speed of fluid</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># Definitions and assignments</span>
    <span class="n">a</span>   <span class="o">=</span> <span class="mf">0.</span>                <span class="c1"># Left border</span>
    <span class="n">b</span>   <span class="o">=</span> <span class="mf">1.</span>                <span class="c1"># Right border</span>
    <span class="n">dx</span>  <span class="o">=</span> <span class="p">(</span><span class="n">b</span><span class="o">-</span><span class="n">a</span><span class="p">)</span><span class="o">/</span><span class="n">Nx</span>          <span class="c1"># Distance between grid points</span>

    <span class="c1"># Define the boundary conditions</span>
    <span class="n">bc_l</span>  <span class="o">=</span> <span class="mi">1</span>       <span class="c1"># Left BC</span>
    <span class="n">bc_r</span>  <span class="o">=</span> <span class="mi">0</span>       <span class="c1"># Right BC</span>

    <span class="c1"># Define index arrays </span>
    <span class="n">k</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">Nx</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">kr</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">Nx</span><span class="p">)</span>
    <span class="n">kl</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">Nx</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Initial quantity field</span>
    <span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nx</span><span class="p">)</span>
                 
    <span class="c1"># Set boundary condiiton</span>
    <span class="n">phi</span><span class="p">[</span><span class="n">Nx</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">bc_r</span>
    <span class="n">phi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">bc_l</span>

    <span class="c1"># Dimensionless parameters</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">K</span><span class="o">*</span><span class="n">dt</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">dx</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">u</span><span class="o">*</span><span class="n">dt</span><span class="p">)</span><span class="o">/</span><span class="n">dx</span>

    <span class="c1"># Time loop</span>
    <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">while</span> <span class="n">t</span> <span class="o">&lt;=</span> <span class="n">integration</span><span class="p">:</span>
        <span class="c1"># Update flux</span>
        <span class="n">phi</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">d</span><span class="p">)</span><span class="o">*</span><span class="n">phi</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">d</span><span class="o">-</span><span class="p">(</span><span class="n">c</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">phi</span><span class="p">[</span><span class="n">kr</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">d</span><span class="o">+</span><span class="p">(</span><span class="n">c</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">phi</span><span class="p">[</span><span class="n">kl</span><span class="p">]</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="n">dt</span>    
        
    <span class="k">return</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">phi</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">advection_diffusion</span><span class="p">(</span><span class="n">u</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">K</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">integration</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="mf">0.000028</span><span class="p">,</span> <span class="n">Nx</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>

<span class="c1"># Plot dimensionless parameters and plot data</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Dimensionless parameter c: </span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Dimensionless parameter d: </span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Dimensionless parameter c: 0.0112
Dimensionless parameter d: 0.0045
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&lt;matplotlib.lines.Line2D at 0x107935b70&gt;]
</pre></div>
</div>
<img alt="../_images/nb_advection_2_2.png" src="../_images/nb_advection_2_2.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define the CFL criteria</span>
<span class="n">CFL</span> <span class="o">=</span> <span class="mf">1.0</span>

<span class="c1"># Print required time steps according to the CFL criteria</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;required dt (advection) &lt;= </span><span class="si">{:.4f}</span><span class="s2"> s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">CFL</span> <span class="o">*</span> <span class="n">dx</span><span class="p">)</span><span class="o">/</span><span class="n">u</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;required dt (diffusion) &lt;= </span><span class="si">{:.4f}</span><span class="s2"> s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(((</span><span class="n">CFL</span> <span class="o">*</span> <span class="n">dx</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">K</span><span class="p">)))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>required dt (advection) &lt;= 0.0025 s
required dt (diffusion) &lt;= 0.0031 s
</pre></div>
</div>
</div>
</div>
<p><strong>Task 5</strong>: Solve the Advection-Diffusion equation, with the following initial impulse signal and boundary conditions:</p>
<div class="amsmath math notranslate nohighlight" id="equation-0b986a0d-ccb5-425d-8095-ad0b2bd46cf3">
<span class="eqno">()<a class="headerlink" href="#equation-0b986a0d-ccb5-425d-8095-ad0b2bd46cf3" title="Permalink to this equation">#</a></span>\[\begin{align}
c(n,0) &amp;=exp^{\left(-\left(\frac{(x-10)}{2}\right)^2\right)} \\
c(0,t) &amp;=0 \\
c(L,t) &amp;=\frac{\partial c}{\partial x}=0
\end{align}\]</div>
<p>Integrate the equation with K=0.1, u=1.0 over 0.05 s with a Δ𝑡=0.0028. Plot the results and the dimensionless time scales. Increase gradually Δ𝑡 and plot and analyse the results for different integration times.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">math</span>

<span class="o">%</span><span class="k">matplotlib</span> inline


<span class="k">def</span> <span class="nf">advection_diffusion</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">integration</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">Nx</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Simple advection-diffusion equation.</span>
<span class="sd">    </span>
<span class="sd">    integration :: Integration time in seconds</span>
<span class="sd">    Nx          :: Number of grid points</span>
<span class="sd">    dt          :: time step in seconds</span>
<span class="sd">    K           :: turbulent diffusivity</span>
<span class="sd">    u           :: Speed of fluid</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># Definitions and assignments</span>
    <span class="n">a</span>   <span class="o">=</span> <span class="mf">0.</span>                <span class="c1"># Left border</span>
    <span class="n">b</span>   <span class="o">=</span> <span class="mf">1.</span>                <span class="c1"># Right border</span>
    <span class="n">dx</span>  <span class="o">=</span> <span class="p">(</span><span class="n">b</span><span class="o">-</span><span class="n">a</span><span class="p">)</span><span class="o">/</span><span class="n">Nx</span>          <span class="c1"># Distance between grid points</span>

    <span class="c1"># Define the boundary conditions</span>
    <span class="n">bc_l</span>  <span class="o">=</span> <span class="mi">0</span>       <span class="c1"># Left BC</span>
    <span class="n">bc_r</span>  <span class="o">=</span> <span class="mi">0</span>       <span class="c1"># Right BC</span>

    <span class="c1"># Define index arrays </span>
    <span class="n">k</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">Nx</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">kr</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">Nx</span><span class="p">)</span>
    <span class="n">kl</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">Nx</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Initial temperature field</span>
    <span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(((</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">Nx</span><span class="p">))</span><span class="o">-</span><span class="mi">10</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                 
    <span class="c1"># Set boundary condiiton</span>
    <span class="n">phi</span><span class="p">[</span><span class="n">Nx</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">bc_r</span>
    <span class="n">phi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">bc_l</span>

    <span class="c1"># Dimensionless parameters</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">K</span><span class="o">*</span><span class="n">dt</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">dx</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">u</span><span class="o">*</span><span class="n">dt</span><span class="p">)</span><span class="o">/</span><span class="n">dx</span>

    <span class="c1"># Time loop</span>
    <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span>
  
    <span class="k">while</span> <span class="n">t</span> <span class="o">&lt;=</span> <span class="n">integration</span><span class="p">:</span>
        <span class="c1"># Set BC</span>
        <span class="n">phi</span><span class="p">[</span><span class="n">Nx</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">phi</span><span class="p">[</span><span class="n">Nx</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
        
        <span class="c1"># Update flux</span>
        <span class="n">phi</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">d</span><span class="p">)</span><span class="o">*</span><span class="n">phi</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">d</span><span class="o">-</span><span class="p">(</span><span class="n">c</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">phi</span><span class="p">[</span><span class="n">kr</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">d</span><span class="o">+</span><span class="p">(</span><span class="n">c</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">phi</span><span class="p">[</span><span class="n">kl</span><span class="p">]</span>

        <span class="c1"># Increate time</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="n">dt</span>    
        
    <span class="k">return</span><span class="p">(</span><span class="n">phi</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">phi</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">advection_diffusion</span><span class="p">(</span><span class="n">u</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">K</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">integration</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="mf">0.0028</span><span class="p">,</span> <span class="n">Nx</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;required dt (advection) &lt;= </span><span class="si">{:.4f}</span><span class="s2"> s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="mf">0.3</span><span class="o">*</span><span class="n">dx</span><span class="p">)</span><span class="o">/</span><span class="n">u</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;required dt (diffusion) &lt;= </span><span class="si">{:.4f}</span><span class="s2"> s&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(((</span><span class="n">dx</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">K</span><span class="p">)))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>       
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Courant number (c): </span><span class="si">{:.4f}</span><span class="s1"> (C&lt;1)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Characteristic diffusion time (d): </span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>required dt (advection) &lt;= 0.0075 s
required dt (diffusion) &lt;= 0.0031 s

Courant number (c): 0.1120 (C&lt;1)
Characteristic diffusion time (d): 0.4480
</pre></div>
</div>
<img alt="../_images/nb_advection_6_1.png" src="../_images/nb_advection_6_1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Simulate evolution for different integration, e.g. 0.05, 0.1, 0.25</span>
<span class="n">phi1</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">advection_diffusion</span><span class="p">(</span><span class="n">u</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">K</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">integration</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="mf">0.0028</span><span class="p">,</span> <span class="n">Nx</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>
<span class="n">phi2</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">advection_diffusion</span><span class="p">(</span><span class="n">u</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">K</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">integration</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="mf">0.0028</span><span class="p">,</span> <span class="n">Nx</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>
<span class="n">phi3</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">advection_diffusion</span><span class="p">(</span><span class="n">u</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">K</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">integration</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="mf">0.0028</span><span class="p">,</span> <span class="n">Nx</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>


<span class="c1"># Plot the results</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">phi1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">phi2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">phi3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/nb_advection_7_0.png" src="../_images/nb_advection_7_0.png" />
</div>
</div>
<p><strong>Task 6</strong>: Starting with the heat equation above simplify the equation to model the temperature evolution in the boundary layer from the surface up to H=2 km height. Assume a fair-weather condition with a subsidence of -0.001 m s-1. Also assume horizontal homogeneity. Parameterize the heat flux using the eddy-diffusivity closure with K=0.25 m s-2. Solve the simplified equation using the following initial and boundary conditions:</p>
<div class="amsmath math notranslate nohighlight" id="equation-9f288d16-9e47-496a-bdd1-fda8abd044ab">
<span class="eqno">()<a class="headerlink" href="#equation-9f288d16-9e47-496a-bdd1-fda8abd044ab" title="Permalink to this equation">#</a></span>\[\begin{align}
\theta(z,0)=290~K \\
\overline{w'\theta'}(z,0)=0~W~m^{−2} \\
\theta(0,t)=290+10 \cdot sin\left(\frac{2\pi \cdot t}{86400}\right)~K \\
\theta(H,t)=\frac{\partial \theta}{\partial z}=0.01~K~m^{-1}
\end{align}\]</div>
<ul class="simple">
<li><p>What happens when you increase the subsidence to -0.01 m s<span class="math notranslate nohighlight">\(^{-1}\)</span>?</p></li>
<li><p>Plot the kinematic heat flux.</p></li>
<li><p>What is the maximum heat flux in W m<span class="math notranslate nohighlight">\(^{-2}\)</span>? Is this a realistic values for a fair-weather condition?</p></li>
<li><p>Calculate the heating rate in K per hour.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">math</span>

<span class="k">def</span> <span class="nf">boundary_layer</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">integration</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">Nz</span><span class="p">,</span> <span class="n">H</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Simple advection-diffusion equation.</span>
<span class="sd">    </span>
<span class="sd">    integration :: Integration time in seconds</span>
<span class="sd">    Nz          :: Number of grid points</span>
<span class="sd">    dt          :: time step in seconds</span>
<span class="sd">    K           :: turbulent diffusivity</span>
<span class="sd">    u           :: Speed of fluid</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># Definitions and assignments</span>
    <span class="n">a</span>   <span class="o">=</span> <span class="mf">0.</span>                <span class="c1"># Left border</span>
    <span class="n">b</span>   <span class="o">=</span> <span class="n">H</span>                 <span class="c1"># Right border</span>
    <span class="n">dz</span>  <span class="o">=</span> <span class="p">(</span><span class="n">b</span><span class="o">-</span><span class="n">a</span><span class="p">)</span><span class="o">/</span><span class="n">Nz</span>          <span class="c1"># Distance between grid points</span>

    <span class="c1"># Define the boundary conditions</span>
    <span class="n">bc_t</span>  <span class="o">=</span> <span class="mi">0</span>       <span class="c1"># top BC</span>
    <span class="n">bc_b</span>  <span class="o">=</span> <span class="mi">0</span>       <span class="c1"># bottom BC</span>

    <span class="c1"># Define index arrays </span>
    <span class="n">k</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">Nz</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">kr</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">Nz</span><span class="p">)</span>
    <span class="n">kl</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">Nz</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Initial temperature field</span>
    <span class="c1"># CHANGE LINES HERE</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="mi">290</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">Nz</span><span class="p">)</span>
    <span class="n">cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nz</span><span class="p">)</span>
    <span class="n">adv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nz</span><span class="p">)</span>
    <span class="n">theta_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Nz</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">integration</span><span class="o">/</span><span class="n">dt</span><span class="p">)))</span>
    <span class="n">cov_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Nz</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">integration</span><span class="o">/</span><span class="n">dt</span><span class="p">)))</span>
    <span class="n">adv_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Nz</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">integration</span><span class="o">/</span><span class="n">dt</span><span class="p">)))</span>

    <span class="c1"># Dimensionless parameters</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">K</span><span class="o">*</span><span class="n">dt</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">dz</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">w</span><span class="o">*</span><span class="n">dt</span><span class="p">)</span><span class="o">/</span><span class="n">dz</span>
    
    <span class="c1"># Init time counter</span>
    <span class="n">t</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">integration</span><span class="o">/</span><span class="n">dt</span><span class="p">)):</span>
        
        <span class="c1"># Set BC top</span>
        <span class="c1"># CHANGE LINES HERE</span>
        <span class="n">theta</span><span class="p">[</span><span class="n">Nz</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">theta</span><span class="p">[</span><span class="n">Nz</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.01</span><span class="o">*</span><span class="n">dz</span>
        
        <span class="c1"># Set BC surface</span>
        <span class="c1"># CHANGE LINES HERE</span>
        <span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">290</span> <span class="o">+</span> <span class="mf">10.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">t</span><span class="p">)</span><span class="o">/</span><span class="mi">86400</span><span class="p">)</span>
        
        <span class="c1"># Update flux</span>
        <span class="c1"># CHANGE LINES HERE</span>
        <span class="n">theta</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">d</span><span class="p">)</span><span class="o">*</span><span class="n">theta</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">d</span><span class="o">-</span><span class="p">(</span><span class="n">c</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">theta</span><span class="p">[</span><span class="n">kr</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">d</span><span class="o">+</span><span class="p">(</span><span class="n">c</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">theta</span><span class="p">[</span><span class="n">kl</span><span class="p">]</span>
        <span class="n">theta_all</span><span class="p">[:,</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">theta</span><span class="p">[:]</span>
        <span class="n">adv</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">w</span> <span class="o">*</span> <span class="p">(</span><span class="n">theta</span><span class="p">[</span><span class="n">kr</span><span class="p">]</span><span class="o">-</span><span class="n">theta</span><span class="p">[</span><span class="n">kl</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">dz</span><span class="p">)</span>
        <span class="n">adv_all</span><span class="p">[:,</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">adv</span><span class="p">[:]</span>
        
        <span class="c1"># Calculate and store the covariance</span>
        <span class="c1"># CHANGE LINES HERE</span>
        <span class="n">cov</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="n">K</span> <span class="o">*</span> <span class="p">(</span><span class="n">theta</span><span class="p">[</span><span class="n">kr</span><span class="p">]</span><span class="o">-</span><span class="n">theta</span><span class="p">[</span><span class="n">kl</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">dz</span><span class="p">)</span>
        <span class="n">cov</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cov</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">cov_all</span><span class="p">[:,</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">cov</span><span class="p">[:]</span>
             
        <span class="c1"># Increase time step</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="n">dt</span>
        
    <span class="k">return</span><span class="p">(</span><span class="n">adv_all</span><span class="p">,</span> <span class="n">theta_all</span><span class="p">,</span> <span class="n">cov_all</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">integration</span><span class="p">,</span> <span class="n">dt</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Nz</span><span class="o">*</span><span class="n">dz</span><span class="p">,</span> <span class="n">dz</span><span class="p">),</span> <span class="n">K</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>

<span class="n">phi</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">advection_diffusion</span><span class="p">(</span><span class="n">u</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">K</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">integration</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="mf">0.0028</span><span class="p">,</span> <span class="n">Nx</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">make_plot</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">levels</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="n">xlab</span><span class="p">,</span> <span class="n">zlab</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;RdBu_r&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Useful function for plotting 2D-fields as contour plot&quot;&quot;&quot;</span>
    
    <span class="c1"># Create figure</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span><span class="mi">5</span><span class="p">));</span>
    <span class="n">cn0</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">z</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span><span class="n">levels</span><span class="o">=</span><span class="n">levels</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">);</span>
    
    <span class="c1"># Add the colorbar and set ticks and labels</span>
    <span class="n">cbar</span><span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cn0</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">)</span>
    <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="n">unit</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    
    <span class="c1"># Add labels and modify ticks</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">xlab</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">zlab</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    
    <span class="c1"># return the handler to the figure axes</span>
    <span class="k">return</span> <span class="n">ax</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Nz</span> <span class="o">=</span> <span class="mi">200</span>
<span class="n">H</span> <span class="o">=</span> <span class="mi">500</span>
<span class="n">integration</span> <span class="o">=</span> <span class="mi">86400</span><span class="o">*</span><span class="mi">3</span>
<span class="n">dt</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c1"># Run the boundary layer model</span>
<span class="n">adv</span><span class="p">,</span> <span class="n">phi1</span><span class="p">,</span> <span class="n">cov</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">boundary_layer</span><span class="p">(</span><span class="n">w</span><span class="o">=-</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">K</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">integration</span><span class="o">=</span><span class="n">integration</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="n">dt</span><span class="p">,</span> <span class="n">Nz</span><span class="o">=</span><span class="n">Nz</span><span class="p">,</span> <span class="n">H</span><span class="o">=</span><span class="n">H</span><span class="p">)</span>

<span class="c1"># Create 2D mesh grid</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">make_plot</span><span class="p">(</span><span class="n">adv</span><span class="o">+</span><span class="n">cov</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="mi">21</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Theta&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;K&#39;</span><span class="p">,</span> <span class="n">xlab</span><span class="o">=</span><span class="s1">&#39;Hours&#39;</span><span class="p">,</span> <span class="n">zlab</span><span class="o">=</span><span class="s1">&#39;Height&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;RdBu_r&#39;</span><span class="p">)</span>

<span class="c1"># Correct the ticks</span>
<span class="c1">#ax.set_xticks(x[x%(3600*6)==0]);</span>
<span class="c1">#ax.set_xticklabels(list(map(str,(x[x%(3600*6)==0]/3600))), size=10, weight=&#39;normal&#39;);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/nb_advection_11_0.png" src="../_images/nb_advection_11_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot the heat fluxes</span>

<span class="c1"># Create 2D plot for the covariance</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">make_plot</span><span class="p">(</span><span class="n">cov</span><span class="p">[:]</span><span class="o">*</span><span class="mi">1004</span><span class="o">*</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="mi">21</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Theta&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;W m$^{-2}$&#39;</span><span class="p">,</span> <span class="n">xlab</span><span class="o">=</span><span class="s1">&#39;Hours&#39;</span><span class="p">,</span> <span class="n">zlab</span><span class="o">=</span><span class="s1">&#39;Height&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;RdBu_r&#39;</span><span class="p">)</span>
<span class="c1"># Correct the ticks</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">x</span><span class="o">%</span><span class="p">(</span><span class="mi">3600</span><span class="o">*</span><span class="mi">6</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">]);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,(</span><span class="n">x</span><span class="p">[</span><span class="n">x</span><span class="o">%</span><span class="p">(</span><span class="mi">3600</span><span class="o">*</span><span class="mi">6</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">3600</span><span class="p">))),</span> <span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;normal&#39;</span><span class="p">);</span>

<span class="c1"># Create 2D plot for the kinematic heat flux</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">make_plot</span><span class="p">(</span><span class="n">cov</span><span class="p">[:],</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="mi">21</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Kinematic heat flux&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;K m s$^{-1}$&#39;</span><span class="p">,</span> <span class="n">xlab</span><span class="o">=</span><span class="s1">&#39;Hours&#39;</span><span class="p">,</span> <span class="n">zlab</span><span class="o">=</span><span class="s1">&#39;Height&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;RdBu_r&#39;</span><span class="p">)</span>
<span class="c1"># Correct the ticks</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">x</span><span class="o">%</span><span class="p">(</span><span class="mi">3600</span><span class="o">*</span><span class="mi">6</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">]);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,(</span><span class="n">x</span><span class="p">[</span><span class="n">x</span><span class="o">%</span><span class="p">(</span><span class="mi">3600</span><span class="o">*</span><span class="mi">6</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">3600</span><span class="p">))),</span> <span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="s1">&#39;normal&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/nb_advection_12_0.png" src="../_images/nb_advection_12_0.png" />
<img alt="../_images/nb_advection_12_1.png" src="../_images/nb_advection_12_1.png" />
</div>
</div>
<p><strong>Task 7</strong>: Intense boundary layer convection may develop when cold air masses are advected over relatively warm surfaces. Develop a simple model for this by assuming that the time evolution of the boundary layer is determined by the vertical turbulent heat transport and the horizontal heat advection. Make the following assumptions: [Hint: use the eddy-diffusivity closure and the upwind scheme for the advection flux]</p>
<img alt="../_images/lake_erie_exercise.png" src="../_images/lake_erie_exercise.png" />
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">math</span>

<span class="k">def</span> <span class="nf">boundary_layer_evolution</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dz</span><span class="p">,</span> <span class="n">Nx</span><span class="p">,</span> <span class="n">Nz</span><span class="p">,</span> <span class="n">hours</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Simple advection-diffusion equation.</span>
<span class="sd">    </span>
<span class="sd">    integration :: Integration time in seconds</span>
<span class="sd">    Nz          :: Number of grid points</span>
<span class="sd">    dt          :: time step in seconds</span>
<span class="sd">    K           :: turbulent diffusivity</span>
<span class="sd">    u           :: Speed of fluid</span>
<span class="sd">    &quot;&quot;&quot;</span>
       
    <span class="c1"># Some definitions</span>
    <span class="c1"># Multiply the hours given by the user by 3600 s to </span>
    <span class="c1"># get the integration time in seconds</span>
    <span class="n">integration</span> <span class="o">=</span> <span class="n">hours</span><span class="o">*</span><span class="mi">3600</span>
    
    <span class="c1"># Define index arrays </span>
    <span class="c1"># Since this a 2D problem we need to define two index arrays.</span>
    <span class="c1"># The first set of index arrays is used for indexing in x-direction. This</span>
    <span class="c1"># is needed to calculate the derivatives in x-direction (advection)</span>
    <span class="n">k</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">Nx</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># center cell</span>
    <span class="n">kr</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">Nx</span><span class="p">)</span>   <span class="c1"># cells to the right</span>
    <span class="n">kl</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">Nx</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># cells to the left</span>
    
    <span class="c1"># The second set of index arrays is used for indexing in z-direction. This</span>
    <span class="c1"># is needed to calculate the derivates in z-direction (turbulent diffusion)</span>
    <span class="n">m</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">Nz</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># center cell</span>
    <span class="n">mu</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">Nz</span><span class="p">)</span>   <span class="c1"># cells above </span>
    <span class="n">md</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">Nz</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># cells below</span>

    <span class="c1"># Initial temperature field</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="mi">268</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">Nz</span><span class="p">,</span> <span class="n">Nx</span><span class="p">))</span> <span class="c1"># Temperature field is initialized with 268 K</span>
    <span class="n">cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Nz</span><span class="p">,</span> <span class="n">Nx</span><span class="p">))</span>        <span class="c1"># Empty array for the covariances</span>
    <span class="n">adv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Nz</span><span class="p">,</span> <span class="n">Nx</span><span class="p">))</span>        <span class="c1"># Empty array for the advection term </span>
    
    <span class="c1"># Define the boundary conditions</span>
    <span class="c1"># Set BC surface</span>
    <span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">268</span>
    
    <span class="c1"># The lower temperature boundary needs to be updated where there is the lake</span>
    <span class="c1"># Here, were set the temperature at the lower boundary from the grid cell 50</span>
    <span class="c1"># to 150 to a temperature of 278 K</span>
    <span class="n">lake_from</span> <span class="o">=</span> <span class="mi">50</span>
    <span class="n">lake_to</span> <span class="o">=</span> <span class="mi">150</span>
    <span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">lake_from</span><span class="p">:</span><span class="n">lake_to</span><span class="p">]</span> <span class="o">=</span> <span class="mi">278</span>
    
    <span class="c1"># Dimensionless parameters</span>
    <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">u</span><span class="o">*</span><span class="n">dt</span><span class="p">)</span><span class="o">/</span><span class="n">dx</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">K</span><span class="o">*</span><span class="n">dt</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">dz</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># Integrate the model</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">integration</span><span class="o">/</span><span class="n">dt</span><span class="p">)):</span>

        <span class="c1"># Set BC top (Neumann condition)</span>
        <span class="c1"># The last term accounts for the fixed gradient of 0.01</span>
        <span class="n">theta</span><span class="p">[</span><span class="n">Nz</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">theta</span><span class="p">[</span><span class="n">Nz</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="mf">0.01</span> <span class="o">*</span> <span class="n">dz</span>
        
        <span class="c1"># Set BC right (Dirichlet condition)</span>
        <span class="n">theta</span><span class="p">[:,</span> <span class="n">Nx</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">theta</span><span class="p">[:,</span> <span class="n">Nx</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
        
        <span class="c1"># We need to keep track of the old values for calculating the new derivatives.</span>
        <span class="c1"># That means, the temperature value a grid cell is calculated from its values </span>
        <span class="c1"># plus the correction term calculated from the old values. This guarantees that</span>
        <span class="c1"># the gradients for the x an z direction are based on the same old values.</span>
        <span class="n">old</span> <span class="o">=</span> <span class="n">theta</span>
            
        <span class="c1"># First update grid cells in z-direction. Here, we loop over all x grid cells and</span>
        <span class="c1"># use the index arrays m, mu, md to calculate the gradients for the</span>
        <span class="c1"># turbulent diffusion (which only depends on z)</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">Nx</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="c1"># temperature - turbulent diffusion</span>
            <span class="n">theta</span><span class="p">[</span><span class="n">m</span><span class="p">,</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">theta</span><span class="p">[</span><span class="n">m</span><span class="p">,</span><span class="n">x</span><span class="p">]</span> <span class="o">+</span> <span class="p">((</span><span class="n">K</span><span class="o">*</span><span class="n">dt</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">dz</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="n">old</span><span class="p">[</span><span class="n">mu</span><span class="p">,</span><span class="n">x</span><span class="p">]</span><span class="o">+</span><span class="n">old</span><span class="p">[</span><span class="n">md</span><span class="p">,</span><span class="n">x</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">old</span><span class="p">[</span><span class="n">m</span><span class="p">,</span><span class="n">x</span><span class="p">])</span>
            <span class="c1"># Calculate the warming rate [K/s] by covariance</span>
            <span class="n">cov</span><span class="p">[</span><span class="n">m</span><span class="p">,</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">K</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">dz</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="n">old</span><span class="p">[</span><span class="n">mu</span><span class="p">,</span><span class="n">x</span><span class="p">]</span><span class="o">+</span><span class="n">old</span><span class="p">[</span><span class="n">md</span><span class="p">,</span><span class="n">x</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">old</span><span class="p">[</span><span class="n">m</span><span class="p">,</span><span class="n">x</span><span class="p">])</span>

        <span class="c1"># Then update grid cells in x-direction. Here, we loop over all z grid cells and</span>
        <span class="c1"># use the index arrays k, kl, kr to calculate the gradients for the</span>
        <span class="c1"># advection (which only depends on x)</span>
        <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">Nz</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="c1"># temperature advection</span>
            <span class="n">theta</span><span class="p">[</span><span class="n">z</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">theta</span><span class="p">[</span><span class="n">z</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="p">((</span><span class="n">u</span><span class="o">*</span><span class="n">dt</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">dx</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="n">old</span><span class="p">[</span><span class="n">z</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">-</span><span class="n">old</span><span class="p">[</span><span class="n">z</span><span class="p">,</span><span class="n">kl</span><span class="p">])</span>
            <span class="c1"># Calculate the warming rate [K/s] by the horizontal advection </span>
            <span class="c1"># Note: Here, we use a so-called upwind-scheme (backward discretization)</span>
            <span class="n">adv</span><span class="p">[</span><span class="n">z</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="p">(</span><span class="n">u</span><span class="o">/</span><span class="n">dx</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">old</span><span class="p">[</span><span class="n">z</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">-</span><span class="n">old</span><span class="p">[</span><span class="n">z</span><span class="p">,</span><span class="n">kl</span><span class="p">])</span>

    <span class="c1"># Return results    </span>
    <span class="k">return</span> <span class="n">theta</span><span class="p">,</span> <span class="n">cov</span><span class="p">,</span> <span class="n">adv</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Nx</span><span class="o">*</span><span class="n">dx</span><span class="p">,</span> <span class="n">dx</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Nz</span><span class="o">*</span><span class="n">dz</span><span class="p">,</span> <span class="n">dz</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run the model</span>
<span class="n">theta</span><span class="p">,</span> <span class="n">cov</span><span class="p">,</span> <span class="n">adv</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">boundary_layer_evolution</span><span class="p">(</span><span class="n">u</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">K</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">dz</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">Nx</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span> <span class="n">Nz</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">hours</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="mi">75</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create 2D plot for the covariance</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">make_plot</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="o">/</span><span class="mi">500</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="mi">21</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Heat flux&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;W m$^{-2}$&#39;</span><span class="p">,</span> 
               <span class="n">xlab</span><span class="o">=</span><span class="s1">&#39;Distance [km]&#39;</span><span class="p">,</span> <span class="n">zlab</span><span class="o">=</span><span class="s1">&#39;Height [m]&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;RdBu_r&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/nb_advection_17_0.png" src="../_images/nb_advection_17_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot the warming rate by turbulent mixing</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">make_plot</span><span class="p">(</span><span class="n">cov</span><span class="o">*</span><span class="mi">3600</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="mi">21</span><span class="p">,</span> 
               <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Warming rate by turbulent mixing&#39;</span><span class="p">,</span> 
               <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;K h$^{-1}$&#39;</span><span class="p">,</span> 
               <span class="n">xlab</span><span class="o">=</span><span class="s1">&#39;Distance&#39;</span><span class="p">,</span> 
               <span class="n">zlab</span><span class="o">=</span><span class="s1">&#39;Height&#39;</span><span class="p">,</span> 
               <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;RdBu_r&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Maximum warming rate by turbulent mixing: </span><span class="si">{:.2f}</span><span class="s1"> K/h&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">cov</span><span class="o">*</span><span class="mi">3600</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Maximum warming rate by turbulent mixing: 24.41 K/h
</pre></div>
</div>
<img alt="../_images/nb_advection_18_1.png" src="../_images/nb_advection_18_1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot the warming rate by advection</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">make_plot</span><span class="p">(</span><span class="n">adv</span><span class="o">*</span><span class="mi">3600</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="mi">21</span><span class="p">,</span> 
               <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Warming rate due to advection&#39;</span><span class="p">,</span> 
               <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;K h$^{-1}$&#39;</span><span class="p">,</span> 
               <span class="n">xlab</span><span class="o">=</span><span class="s1">&#39;Distance&#39;</span><span class="p">,</span> <span class="n">zlab</span><span class="o">=</span><span class="s1">&#39;Height&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;RdBu_r&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Maximum warming rate by advection: </span><span class="si">{:.2f}</span><span class="s1"> K/h&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">adv</span><span class="o">*</span><span class="mi">3600</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Maximum warming rate by advection: 26.31 K/h
</pre></div>
</div>
<img alt="../_images/nb_advection_19_1.png" src="../_images/nb_advection_19_1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot the total warming rate </span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">make_plot</span><span class="p">((</span><span class="n">adv</span><span class="o">*</span><span class="mi">3600</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">cov</span><span class="o">*</span><span class="mi">3600</span><span class="p">),</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="mi">21</span><span class="p">,</span> 
               <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Warming rate due to advection&#39;</span><span class="p">,</span> 
               <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;K h$^{-1}$&#39;</span><span class="p">,</span> 
               <span class="n">xlab</span><span class="o">=</span><span class="s1">&#39;Distance&#39;</span><span class="p">,</span> <span class="n">zlab</span><span class="o">=</span><span class="s1">&#39;Height&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;RdBu_r&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Maximum total warming rate : </span><span class="si">{:.2f}</span><span class="s1"> K/h&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">((</span><span class="n">cov</span><span class="o">*</span><span class="mi">3600</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">adv</span><span class="o">*</span><span class="mi">3600</span><span class="p">))))</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Minimum total warming rate : </span><span class="si">{:.2f}</span><span class="s1"> K/h&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">((</span><span class="n">cov</span><span class="o">*</span><span class="mi">3600</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">adv</span><span class="o">*</span><span class="mi">3600</span><span class="p">))))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Maximum total warming rate : 17.48 K/h
Minimum total warming rate : -17.49 K/h
</pre></div>
</div>
<img alt="../_images/nb_advection_20_1.png" src="../_images/nb_advection_20_1.png" />
</div>
</div>
<p><strong>Task 8</strong>: Extend the Lake-effect model by adding the moisture transport equation. Assume that the top millimetres above the water surface are saturated. Assume that the atmosphere has a relative humidity of 70 %. Calculate the relative humidity at each grid cell. [Note: Convert the potential temperature to normal temperature and calculate the mixing ratio at each cell. Then calculate the relative humidity.]</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">math</span>
    
<span class="c1"># --------------------------</span>
<span class="c1"># Auxiliary functions</span>
<span class="c1"># --------------------------</span>
<span class="k">def</span> <span class="nf">saturation_water_vapor</span><span class="p">(</span><span class="n">T</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Calculates the saturation water vapor pressure [Pa]&quot;&quot;&quot;</span>
    <span class="c1"># CHANGE LINES HERE</span>
    <span class="k">return</span> <span class="n">XXXXXX</span>

<span class="k">def</span> <span class="nf">hypsometric_eqn</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span> <span class="n">Tv</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Hypsometric equation to calculate the pressure [hPa] at a certain height[m]</span>
<span class="sd">       when the surface pressure is given</span>
<span class="sd">       p0 :: surface pressure [hPa]</span>
<span class="sd">       Tv :: mean virtual temperature of atmosphere [K]</span>
<span class="sd">       z  :: height above ground [m]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># CHANGE LINES HERE</span>
    <span class="k">return</span> <span class="n">XXXXXX</span>

<span class="k">def</span> <span class="nf">mixing_ratio</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">p0</span><span class="p">,</span> <span class="n">Tv</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Calculates the mixing ratio from</span>
<span class="sd">        theta :: temperature [K]</span>
<span class="sd">        p0    :: surface pressure [hPa]</span>
<span class="sd">        Tv    :: mean virtual temperature of atmosphere [K]</span>
<span class="sd">        z     :: height [m]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># CHANGE LINES HERE</span>
    <span class="k">return</span> <span class="n">XXXXXX</span>
           
    
    
    
<span class="k">def</span> <span class="nf">boundary_layer_evolution_moisture</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dz</span><span class="p">,</span> <span class="n">Nx</span><span class="p">,</span> <span class="n">Nz</span><span class="p">,</span> <span class="n">hours</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Simple advection-diffusion equation.</span>
<span class="sd">    </span>
<span class="sd">    integration :: Integration time in seconds</span>
<span class="sd">    Nz          :: Number of grid points</span>
<span class="sd">    dt          :: time step in seconds</span>
<span class="sd">    K           :: turbulent diffusivity</span>
<span class="sd">    u           :: Speed of fluid</span>
<span class="sd">    &quot;&quot;&quot;</span>
       
    <span class="c1"># Some definitions</span>
    <span class="c1"># Multiply the hours given by the user by 3600 s to </span>
    <span class="c1"># get the integration time in seconds</span>
    <span class="n">integration</span> <span class="o">=</span> <span class="n">hours</span><span class="o">*</span><span class="mi">3600</span>
    
    <span class="c1"># Define index arrays </span>
    <span class="c1"># Since this a 2D problem we need to define two index arrays.</span>
    <span class="c1"># The first set of index arrays is used for indexing in x-direction. This</span>
    <span class="c1"># is needed to calculate the derivatives in x-direction (advection)</span>
    <span class="n">k</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">Nx</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># center cell</span>
    <span class="n">kr</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">Nx</span><span class="p">)</span>   <span class="c1"># cells to the right</span>
    <span class="n">kl</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">Nx</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># cells to the left</span>
    
    <span class="c1"># The second set of index arrays is used for indexing in z-direction. This</span>
    <span class="c1"># is needed to calculate the derivates in z-direction (turbulent diffusion)</span>
    <span class="n">m</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">Nz</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># center cell</span>
    <span class="n">mu</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">Nz</span><span class="p">)</span>   <span class="c1"># cells above </span>
    <span class="n">md</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">Nz</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># cells below</span>

    <span class="c1"># Make height grid</span>
    <span class="n">height</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">Nz</span><span class="o">*</span><span class="n">dz</span><span class="p">,</span><span class="n">dz</span><span class="p">),]</span> <span class="o">*</span> <span class="n">Nx</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
    
    <span class="c1"># Lake definition (grid points)</span>
    <span class="n">lake_from</span> <span class="o">=</span> <span class="mi">50</span>
    <span class="n">lake_to</span> <span class="o">=</span> <span class="mi">150</span>
    
    <span class="c1"># --------------------------</span>
    <span class="c1"># Initial temperature field</span>
    <span class="c1"># --------------------------</span>
    <span class="c1"># Neutral stratification with lapse rate of 0.01 K/m</span>
    <span class="c1"># Create a 1D-array with the vertical temperature distribution</span>
    <span class="c1"># Surface = 268 K, decreasing according to the dry-adiabative lapse rate 0.01 K/m</span>
    <span class="n">lapse_rate</span> <span class="o">=</span> <span class="n">XXXXXX</span>
    <span class="n">theta_vec</span> <span class="o">=</span> <span class="n">XXXXXX</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">XXXXXX</span>
    
    <span class="c1"># The lower temperature boundary needs to be updated where there is the lake</span>
    <span class="c1"># Here, were set the temperature at the lower boundary from the grid cell 50</span>
    <span class="c1"># to 150 to a temperature of 278 K</span>
    <span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">lake_from</span><span class="p">:</span><span class="n">lake_to</span><span class="p">]</span> <span class="o">=</span> <span class="mi">278</span>
    
    <span class="c1"># --------------------------</span>
    <span class="c1"># Initialize moisture fields </span>
    <span class="c1"># --------------------------</span>
    <span class="c1"># Init saturation mixing ratio array</span>
    <span class="n">qsat</span> <span class="o">=</span> <span class="n">XXXXXX</span>
    
    <span class="c1"># Use qsat to derive mixing ratio at each grid cell assuming a </span>
    <span class="c1"># decreasing relative humidity from 70 % at the surfacee to 20 % at the top</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">XXXXXX</span>
    
    <span class="c1"># The lower moisture boundary needs to be updated where there is the lake</span>
    <span class="c1"># Here, were set the moisture at the lower boundary from the grid cell 50</span>
    <span class="c1"># to 150 to a mixing ratio of 0.9 times the saturation mixing ratio</span>
    <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">lake_from</span><span class="p">:</span><span class="n">lake_to</span><span class="p">]</span> <span class="o">=</span> <span class="n">XXXXXX</span>

    <span class="c1"># --------------------------</span>
    <span class="c1"># Init other arrays</span>
    <span class="c1"># --------------------------</span>
    <span class="n">cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Nz</span><span class="p">,</span> <span class="n">Nx</span><span class="p">))</span>        <span class="c1"># Empty array for the covariances</span>
    <span class="n">adv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Nz</span><span class="p">,</span> <span class="n">Nx</span><span class="p">))</span>        <span class="c1"># Empty array for the advection term </span>
    
    <span class="c1"># --------------------------</span>
    <span class="c1"># Dimensionless parameters</span>
    <span class="c1"># --------------------------</span>
    <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">u</span><span class="o">*</span><span class="n">dt</span><span class="p">)</span><span class="o">/</span><span class="n">dx</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">K</span><span class="o">*</span><span class="n">dt</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">dz</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># --------------------------</span>
    <span class="c1"># Integrate the model</span>
    <span class="c1"># --------------------------</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">integration</span><span class="o">/</span><span class="n">dt</span><span class="p">)):</span>

        <span class="c1"># Set BC top (Neumann condition)</span>
        <span class="c1"># The last term accounts for the fixed gradient of 0.01</span>
        <span class="n">theta</span><span class="p">[</span><span class="n">Nz</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">XXXXXX</span>
        
        <span class="c1"># Set top BC for moisture</span>
        <span class="n">q</span><span class="p">[</span><span class="n">Nz</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">q</span><span class="p">[</span><span class="n">Nz</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> 
        
        <span class="c1"># Set BC right (Neumann condition)</span>
        <span class="n">theta</span><span class="p">[:,</span> <span class="n">Nx</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">tXXXXXX</span>
        
        <span class="c1"># Set right BC for moisture</span>
        <span class="n">q</span><span class="p">[:,</span> <span class="n">Nx</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">XXXXXX</span>
        
        <span class="c1"># We need to keep track of the old values for calculating the new derivatives.</span>
        <span class="c1"># That means, the temperature value a grid cell is calculated from its values </span>
        <span class="c1"># plus the correction term calculated from the old values. This guarantees that</span>
        <span class="c1"># the gradients for the x an z direction are based on the same old values.</span>
        <span class="n">old</span> <span class="o">=</span> <span class="n">theta</span>
        <span class="n">old_q</span> <span class="o">=</span> <span class="n">q</span>
            
        <span class="c1"># First update grid cells in z-direction. Here, we loop over all x grid cells and</span>
        <span class="c1"># use the index arrays m, mu, md to calculate the gradients for the</span>
        <span class="c1"># turbulent diffusion (which only depends on z)</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">Nx</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="c1"># Update temperature including lapse rate </span>
            <span class="n">theta</span><span class="p">[</span><span class="n">m</span><span class="p">,</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">theta</span><span class="p">[</span><span class="n">m</span><span class="p">,</span><span class="n">x</span><span class="p">]</span> <span class="o">+</span> <span class="p">((</span><span class="n">K</span><span class="o">*</span><span class="n">dt</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">dz</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="n">old</span><span class="p">[</span><span class="n">mu</span><span class="p">,</span><span class="n">x</span><span class="p">]</span><span class="o">+</span><span class="n">old</span><span class="p">[</span><span class="n">md</span><span class="p">,</span><span class="n">x</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">old</span><span class="p">[</span><span class="n">m</span><span class="p">,</span><span class="n">x</span><span class="p">])</span> <span class="o">+</span> <span class="n">lapse_rate</span>
            <span class="c1"># Moisture transport (turbulent diffusion)</span>
            <span class="c1"># CHANGE LINES HERE</span>
            <span class="n">q</span><span class="p">[</span><span class="n">m</span><span class="p">,</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">XXXXXX</span>
            <span class="c1"># Calculate the warming rate [K/s] by covariance</span>
            <span class="n">cov</span><span class="p">[</span><span class="n">m</span><span class="p">,</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">K</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">dz</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="n">old</span><span class="p">[</span><span class="n">mu</span><span class="p">,</span><span class="n">x</span><span class="p">]</span><span class="o">+</span><span class="n">old</span><span class="p">[</span><span class="n">md</span><span class="p">,</span><span class="n">x</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">old</span><span class="p">[</span><span class="n">m</span><span class="p">,</span><span class="n">x</span><span class="p">])</span>

        <span class="c1"># Then update grid cells in x-direction. Here, we loop over all z grid cells and</span>
        <span class="c1"># use the index arrays k, kl, kr to calculate the gradients for the</span>
        <span class="c1"># advection (which only depends on x)</span>
        <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">Nz</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="c1"># temperature advection</span>
            <span class="n">theta</span><span class="p">[</span><span class="n">z</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">theta</span><span class="p">[</span><span class="n">z</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="p">((</span><span class="n">u</span><span class="o">*</span><span class="n">dt</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">dx</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="n">old</span><span class="p">[</span><span class="n">z</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">-</span><span class="n">old</span><span class="p">[</span><span class="n">z</span><span class="p">,</span><span class="n">kl</span><span class="p">])</span>
            <span class="c1"># moisture advection</span>
            <span class="c1"># CHANGE LINES HERE</span>
            <span class="n">q</span><span class="p">[</span><span class="n">z</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">XXXXXX</span>
            <span class="c1"># Calculate the warming rate [K/s] by the horizontal advection </span>
            <span class="c1"># Note: Here, we use a so-called upwind-scheme (backward discretization)</span>
            <span class="n">adv</span><span class="p">[</span><span class="n">z</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="p">(</span><span class="n">u</span><span class="o">/</span><span class="n">dx</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">old</span><span class="p">[</span><span class="n">z</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">-</span><span class="n">old</span><span class="p">[</span><span class="n">z</span><span class="p">,</span><span class="n">kl</span><span class="p">])</span>
            
        <span class="c1"># Calculate new saturation mixing ratio</span>
        <span class="c1"># CHANGE LINES HERE</span>
        <span class="n">qsat</span> <span class="o">=</span> <span class="n">XXXXXX</span>
        
        <span class="c1"># Then the relative humidity using qsat</span>
        <span class="c1"># Limit the relative humidity to 100 %</span>
        <span class="c1"># CHANGE LINES HERE</span>
        <span class="n">rH</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">XXXXXX</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        
    <span class="c1"># Return results    </span>
    <span class="k">return</span> <span class="n">theta</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">qsat</span><span class="p">,</span> <span class="n">rH</span><span class="p">,</span> <span class="n">cov</span><span class="p">,</span> <span class="n">adv</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Nx</span><span class="o">*</span><span class="n">dx</span><span class="p">,</span> <span class="n">dx</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Nz</span><span class="o">*</span><span class="n">dz</span><span class="p">,</span> <span class="n">dz</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">height</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="o">*</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">),]</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">height</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run the model</span>
<span class="n">theta</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">qsat</span><span class="p">,</span> <span class="n">rH</span><span class="p">,</span> <span class="n">cov</span><span class="p">,</span> <span class="n">adv</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="n">boundary_layer_evolution_moisture</span><span class="p">(</span><span class="n">u</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">K</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">dz</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> 
                                                                       <span class="n">Nx</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span> <span class="n">Nz</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">hours</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create 2D plot for the covariance</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">make_plot</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Temperature&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;K&#39;</span><span class="p">,</span> 
               <span class="n">xlab</span><span class="o">=</span><span class="s1">&#39;Distance [km]&#39;</span><span class="p">,</span> <span class="n">zlab</span><span class="o">=</span><span class="s1">&#39;Height [m]&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;RdBu_r&#39;</span><span class="p">)</span>

<span class="c1"># Create 2D plot for the covariance</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">make_plot</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Mixing ratio&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;g kg$^{-1}$&#39;</span><span class="p">,</span> 
               <span class="n">xlab</span><span class="o">=</span><span class="s1">&#39;Distance [km]&#39;</span><span class="p">,</span> <span class="n">zlab</span><span class="o">=</span><span class="s1">&#39;Height [m]&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;YlGnBu&#39;</span><span class="p">)</span>

<span class="c1"># Create 2D plot for the covariance</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">make_plot</span><span class="p">(</span><span class="n">qsat</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Saturation mixing ratio&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;g kg$^{-1}$&#39;</span><span class="p">,</span> 
               <span class="n">xlab</span><span class="o">=</span><span class="s1">&#39;Distance [km]&#39;</span><span class="p">,</span> <span class="n">zlab</span><span class="o">=</span><span class="s1">&#39;Height [m]&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;YlGnBu&#39;</span><span class="p">)</span>

<span class="c1"># Create 2D plot for the covariance</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">make_plot</span><span class="p">(</span><span class="n">rH</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Relative humidity&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;%&#39;</span><span class="p">,</span> 
               <span class="n">xlab</span><span class="o">=</span><span class="s1">&#39;Distance [km]&#39;</span><span class="p">,</span> <span class="n">zlab</span><span class="o">=</span><span class="s1">&#39;Height [m]&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;YlGnBu&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span><span class="n">rH</span><span class="p">,</span><span class="n">levels</span><span class="o">=</span><span class="p">[</span><span class="mf">0.95</span><span class="p">,</span><span class="mf">1.0</span><span class="p">],</span><span class="n">colors</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Base run</span>
<span class="n">theta0</span><span class="p">,</span> <span class="n">q0</span><span class="p">,</span> <span class="n">qsat0</span><span class="p">,</span> <span class="n">rH0</span><span class="p">,</span> <span class="n">cov0</span><span class="p">,</span> <span class="n">adv0</span><span class="p">,</span> <span class="n">c0</span><span class="p">,</span> <span class="n">d0</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">z0</span> <span class="o">=</span> <span class="n">boundary_layer_evolution_moisture</span><span class="p">(</span><span class="n">u</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">K</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">dx</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">dz</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> 
                                                                       <span class="n">Nx</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span> <span class="n">Nz</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">hours</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create 2D plot for the covariance</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">make_plot</span><span class="p">(</span><span class="n">theta</span><span class="o">-</span><span class="n">theta0</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Temperature difference&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;K&#39;</span><span class="p">,</span> 
               <span class="n">xlab</span><span class="o">=</span><span class="s1">&#39;Distance [km]&#39;</span><span class="p">,</span> <span class="n">zlab</span><span class="o">=</span><span class="s1">&#39;Height [m]&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;RdBu_r&#39;</span><span class="p">)</span>

<span class="c1"># Create 2D plot for the covariance</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">make_plot</span><span class="p">(</span><span class="n">q</span><span class="o">-</span><span class="n">q0</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Mixing ratio difference&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;g kg$^{-1}$&#39;</span><span class="p">,</span> 
               <span class="n">xlab</span><span class="o">=</span><span class="s1">&#39;Distance [km]&#39;</span><span class="p">,</span> <span class="n">zlab</span><span class="o">=</span><span class="s1">&#39;Height [m]&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;RdBu_r&#39;</span><span class="p">)</span>

<span class="c1"># Create 2D plot for the covariance</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">make_plot</span><span class="p">(</span><span class="n">qsat</span><span class="o">-</span><span class="n">qsat0</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Saturation mixing ratio difference&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;g kg$^{-1}$&#39;</span><span class="p">,</span> 
               <span class="n">xlab</span><span class="o">=</span><span class="s1">&#39;Distance [km]&#39;</span><span class="p">,</span> <span class="n">zlab</span><span class="o">=</span><span class="s1">&#39;Height [m]&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;RdBu_r&#39;</span><span class="p">)</span>

<span class="c1"># Create 2D plot for the covariance</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">make_plot</span><span class="p">((</span><span class="n">rH</span><span class="o">-</span><span class="n">rH0</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Relative humidity difference&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;%&#39;</span><span class="p">,</span> 
               <span class="n">xlab</span><span class="o">=</span><span class="s1">&#39;Distance [km]&#39;</span><span class="p">,</span> <span class="n">zlab</span><span class="o">=</span><span class="s1">&#39;Height [m]&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;RdBu_r&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span><span class="n">rH</span><span class="p">,</span><span class="n">levels</span><span class="o">=</span><span class="p">[</span><span class="mf">0.95</span><span class="p">,</span><span class="mf">1.0</span><span class="p">],</span><span class="n">colors</span><span class="o">=</span><span class="s1">&#39;lightgreen&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">math</span>
    
<span class="c1"># --------------------------</span>
<span class="c1"># Auxiliary functions</span>
<span class="c1"># --------------------------</span>
<span class="k">def</span> <span class="nf">saturation_water_vapor</span><span class="p">(</span><span class="n">T</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Calculates the saturation water vapor pressure [Pa]&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span> <span class="mf">6.122</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="p">(</span><span class="mf">17.67</span><span class="o">*</span><span class="p">(</span><span class="n">T</span><span class="o">-</span><span class="mf">273.16</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">T</span><span class="o">-</span><span class="mf">29.66</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span>

<span class="k">def</span> <span class="nf">hypsometric_eqn</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span> <span class="n">Tv</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Hypsometric equation to calculate the pressure at a certain height </span>
<span class="sd">       when the surface pressure is given</span>
<span class="sd">       p0 :: surface pressure [hPa]</span>
<span class="sd">       Tv :: mean virtual temperature of atmosphere [K]</span>
<span class="sd">       z  :: height above ground [m]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span><span class="p">(</span><span class="n">p0</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="mf">9.81</span><span class="o">*</span><span class="n">z</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">287.4</span><span class="o">*</span><span class="n">Tv</span><span class="p">)</span> <span class="p">)))</span>

<span class="k">def</span> <span class="nf">mixing_ratio</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">p0</span><span class="p">,</span> <span class="n">Tv</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Calculates the mixing ratio from</span>
<span class="sd">        theta :: temperature [K]</span>
<span class="sd">        p0    :: surface pressure [hPa]</span>
<span class="sd">        Tv    :: mean virtual temperature of atmosphere [K]</span>
<span class="sd">        z     :: height [m]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span><span class="p">(</span><span class="mf">622.97</span> <span class="o">*</span> <span class="p">(</span><span class="n">saturation_water_vapor</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">hypsometric_eqn</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span><span class="n">Tv</span><span class="p">,</span><span class="n">z</span><span class="p">)</span><span class="o">-</span><span class="n">saturation_water_vapor</span><span class="p">(</span><span class="n">theta</span><span class="p">))))</span>
           
    
    
    
<span class="k">def</span> <span class="nf">boundary_layer_evolution_moisture_gamma</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dz</span><span class="p">,</span> <span class="n">Nx</span><span class="p">,</span> <span class="n">Nz</span><span class="p">,</span> <span class="n">hours</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Simple advection-diffusion equation.</span>
<span class="sd">    </span>
<span class="sd">    integration :: Integration time in seconds</span>
<span class="sd">    Nz          :: Number of grid points</span>
<span class="sd">    dt          :: time step in seconds</span>
<span class="sd">    K           :: turbulent diffusivity</span>
<span class="sd">    u           :: Speed of fluid</span>
<span class="sd">    &quot;&quot;&quot;</span>
       
    <span class="c1"># Some definitions</span>
    <span class="c1"># Multiply the hours given by the user by 3600 s to </span>
    <span class="c1"># get the integration time in seconds</span>
    <span class="n">integration</span> <span class="o">=</span> <span class="n">hours</span><span class="o">*</span><span class="mi">3600</span>
    
    <span class="c1"># Define index arrays </span>
    <span class="c1"># Since this a 2D problem we need to define two index arrays.</span>
    <span class="c1"># The first set of index arrays is used for indexing in x-direction. This</span>
    <span class="c1"># is needed to calculate the derivatives in x-direction (advection)</span>
    <span class="n">k</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">Nx</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># center cell</span>
    <span class="n">kr</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">Nx</span><span class="p">)</span>   <span class="c1"># cells to the right</span>
    <span class="n">kl</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">Nx</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># cells to the left</span>
    
    <span class="c1"># The second set of index arrays is used for indexing in z-direction. This</span>
    <span class="c1"># is needed to calculate the derivates in z-direction (turbulent diffusion)</span>
    <span class="n">m</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">Nz</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># center cell</span>
    <span class="n">mu</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">Nz</span><span class="p">)</span>   <span class="c1"># cells above </span>
    <span class="n">md</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">Nz</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># cells below</span>

    <span class="c1"># Make height grid</span>
    <span class="n">height</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">Nz</span><span class="o">*</span><span class="n">dz</span><span class="p">,</span><span class="n">dz</span><span class="p">),]</span> <span class="o">*</span> <span class="n">Nx</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
    
    <span class="c1"># Make lapse rate array</span>
    <span class="n">Gamma</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.01</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">Nz</span><span class="p">,</span> <span class="n">Nx</span><span class="p">))</span>
    
    <span class="c1"># Lake definition (grid points)</span>
    <span class="n">lake_from</span> <span class="o">=</span> <span class="mi">50</span>
    <span class="n">lake_to</span> <span class="o">=</span> <span class="mi">150</span>
    
    <span class="c1"># --------------------------</span>
    <span class="c1"># Initial temperature field</span>
    <span class="c1"># --------------------------</span>
    <span class="c1"># Neutral stratification with lapse rate of 0.01 K/m</span>
    <span class="c1"># Create a 1D-array with the vertical temperature distribution</span>
    <span class="c1"># Surface = 268 K, decreasing according to the dry-adiabative lapse rate 0.01 K/m</span>
    <span class="n">lapse_rate</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.01</span>
    <span class="n">theta_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">268</span> <span class="o">+</span> <span class="n">lapse_rate</span> <span class="o">*</span> <span class="p">(</span><span class="n">dz</span> <span class="o">*</span> <span class="n">z</span><span class="p">)</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nz</span><span class="p">)])</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">theta_vec</span><span class="p">,]</span> <span class="o">*</span> <span class="n">Nx</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span> 
    
    <span class="c1"># The lower temperature boundary needs to be updated where there is the lake</span>
    <span class="c1"># Here, were set the temperature at the lower boundary from the grid cell 50</span>
    <span class="c1"># to 150 to a temperature of 278 K</span>
    <span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">lake_from</span><span class="p">:</span><span class="n">lake_to</span><span class="p">]</span> <span class="o">=</span> <span class="mi">278</span>
    
    <span class="c1"># --------------------------</span>
    <span class="c1"># Initialize moisture fields </span>
    <span class="c1"># --------------------------</span>
    <span class="c1"># Init moisture array with a relative humidity of 70 %</span>
    <span class="n">qsat</span> <span class="o">=</span> <span class="n">mixing_ratio</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="mi">1013</span><span class="p">,</span> <span class="mi">270</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
    
    <span class="c1"># Multiply with relative humidity (80 %)</span>
    <span class="n">q</span> <span class="o">=</span> <span class="p">(</span><span class="n">qsat</span><span class="o">.</span><span class="n">T</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="n">Nz</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    
    
    <span class="c1"># The lower moisture boundary needs to be updated where there is the lake</span>
    <span class="c1"># Here, were set the moisture at the lower boundary from the grid cell 50</span>
    <span class="c1"># to 150 to a mixing ratio of 0.9 times the saturation mixing ratio</span>
    <span class="n">q</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">lake_from</span><span class="p">:</span><span class="n">lake_to</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.9</span> <span class="o">*</span> <span class="n">qsat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">lake_from</span><span class="p">:</span><span class="n">lake_to</span><span class="p">]</span> 

    <span class="c1"># --------------------------</span>
    <span class="c1"># Init other arrays</span>
    <span class="c1"># --------------------------</span>
    <span class="n">cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Nz</span><span class="p">,</span> <span class="n">Nx</span><span class="p">))</span>        <span class="c1"># Empty array for the covariances</span>
    <span class="n">adv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">Nz</span><span class="p">,</span> <span class="n">Nx</span><span class="p">))</span>        <span class="c1"># Empty array for the advection term </span>
    
    <span class="c1"># --------------------------</span>
    <span class="c1"># Dimensionless parameters</span>
    <span class="c1"># --------------------------</span>
    <span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">u</span><span class="o">*</span><span class="n">dt</span><span class="p">)</span><span class="o">/</span><span class="n">dx</span>
    <span class="n">d</span> <span class="o">=</span> <span class="p">(</span><span class="n">K</span><span class="o">*</span><span class="n">dt</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">dz</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># --------------------------</span>
    <span class="c1"># Integrate the model</span>
    <span class="c1"># --------------------------</span>
    <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">integration</span><span class="o">/</span><span class="n">dt</span><span class="p">)):</span>

        <span class="c1"># Set BC top (Neumann condition)</span>
        <span class="c1"># The last term accounts for the fixed gradient of 0.01</span>
        <span class="n">theta</span><span class="p">[</span><span class="n">Nz</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">theta</span><span class="p">[</span><span class="n">Nz</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span><span class="c1"># - 0.005 * dz</span>
        
        <span class="c1"># Set top BC for moisture</span>
        <span class="n">q</span><span class="p">[</span><span class="n">Nz</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">q</span><span class="p">[</span><span class="n">Nz</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]</span> 
        
        <span class="c1"># Set BC right (Dirichlet condition)</span>
        <span class="n">theta</span><span class="p">[:,</span> <span class="n">Nx</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">theta</span><span class="p">[:,</span> <span class="n">Nx</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
        
        <span class="c1"># Set right BC for moisture</span>
        <span class="n">q</span><span class="p">[:,</span> <span class="n">Nx</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">q</span><span class="p">[:,</span> <span class="n">Nx</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
        
        <span class="c1"># We need to keep track of the old values for calculating the new derivatives.</span>
        <span class="c1"># That means, the temperature value a grid cell is calculated from its values </span>
        <span class="c1"># plus the correction term calculated from the old values. This guarantees that</span>
        <span class="c1"># the gradients for the x an z direction are based on the same old values.</span>
        <span class="n">old</span> <span class="o">=</span> <span class="n">theta</span>
        <span class="n">old_q</span> <span class="o">=</span> <span class="n">q</span>
            
        <span class="c1"># First update grid cells in z-direction. Here, we loop over all x grid cells and</span>
        <span class="c1"># use the index arrays m, mu, md to calculate the gradients for the</span>
        <span class="c1"># turbulent diffusion (which only depends on z)</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">Nx</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="c1"># Temperature diffusion + lapse rate </span>
            <span class="n">theta</span><span class="p">[</span><span class="n">m</span><span class="p">,</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">theta</span><span class="p">[</span><span class="n">m</span><span class="p">,</span><span class="n">x</span><span class="p">]</span> <span class="o">+</span> <span class="p">((</span><span class="n">K</span><span class="o">*</span><span class="n">dt</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">dz</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="n">old</span><span class="p">[</span><span class="n">mu</span><span class="p">,</span><span class="n">x</span><span class="p">]</span><span class="o">+</span><span class="n">old</span><span class="p">[</span><span class="n">md</span><span class="p">,</span><span class="n">x</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">old</span><span class="p">[</span><span class="n">m</span><span class="p">,</span><span class="n">x</span><span class="p">])</span> <span class="o">+</span> <span class="n">Gamma</span><span class="p">[</span><span class="n">m</span><span class="p">,</span><span class="n">x</span><span class="p">]</span>
            <span class="c1"># Turbulent diffusion of moisture</span>
            <span class="n">q</span><span class="p">[</span><span class="n">m</span><span class="p">,</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">q</span><span class="p">[</span><span class="n">m</span><span class="p">,</span><span class="n">x</span><span class="p">]</span> <span class="o">+</span> <span class="p">((</span><span class="n">K</span><span class="o">*</span><span class="n">dt</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">dz</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="n">old_q</span><span class="p">[</span><span class="n">mu</span><span class="p">,</span><span class="n">x</span><span class="p">]</span><span class="o">+</span><span class="n">old_q</span><span class="p">[</span><span class="n">md</span><span class="p">,</span><span class="n">x</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">old_q</span><span class="p">[</span><span class="n">m</span><span class="p">,</span><span class="n">x</span><span class="p">])</span>
            <span class="c1"># Calculate the warming rate [K/s] by covariance</span>
            <span class="n">cov</span><span class="p">[</span><span class="n">m</span><span class="p">,</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">K</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">dz</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="n">old</span><span class="p">[</span><span class="n">mu</span><span class="p">,</span><span class="n">x</span><span class="p">]</span><span class="o">+</span><span class="n">old</span><span class="p">[</span><span class="n">md</span><span class="p">,</span><span class="n">x</span><span class="p">]</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">old</span><span class="p">[</span><span class="n">m</span><span class="p">,</span><span class="n">x</span><span class="p">])</span>

        <span class="c1"># Then update grid cells in x-direction. Here, we loop over all z grid cells and</span>
        <span class="c1"># use the index arrays k, kl, kr to calculate the gradients for the</span>
        <span class="c1"># advection (which only depends on x)</span>
        <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">Nz</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="c1"># temperature advection</span>
            <span class="n">theta</span><span class="p">[</span><span class="n">z</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">theta</span><span class="p">[</span><span class="n">z</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="p">((</span><span class="n">u</span><span class="o">*</span><span class="n">dt</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">dx</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="n">old</span><span class="p">[</span><span class="n">z</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">-</span><span class="n">old</span><span class="p">[</span><span class="n">z</span><span class="p">,</span><span class="n">kl</span><span class="p">])</span>
            <span class="c1"># moisture advection</span>
            <span class="n">q</span><span class="p">[</span><span class="n">z</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">q</span><span class="p">[</span><span class="n">z</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">-</span> <span class="p">((</span><span class="n">u</span><span class="o">*</span><span class="n">dt</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">dx</span><span class="p">))</span><span class="o">*</span><span class="p">(</span><span class="n">old_q</span><span class="p">[</span><span class="n">z</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">-</span><span class="n">old_q</span><span class="p">[</span><span class="n">z</span><span class="p">,</span><span class="n">kl</span><span class="p">])</span>
            <span class="c1"># Calculate the warming rate [K/s] by the horizontal advection </span>
            <span class="c1"># Note: Here, we use a so-called upwind-scheme (backward discretization)</span>
            <span class="n">adv</span><span class="p">[</span><span class="n">z</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span> <span class="p">(</span><span class="n">u</span><span class="o">/</span><span class="n">dx</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">old</span><span class="p">[</span><span class="n">z</span><span class="p">,</span><span class="n">k</span><span class="p">]</span><span class="o">-</span><span class="n">old</span><span class="p">[</span><span class="n">z</span><span class="p">,</span><span class="n">kl</span><span class="p">])</span>
            
        <span class="c1"># Calculate new saturation mixing ratio</span>
        <span class="n">qsat</span> <span class="o">=</span> <span class="n">mixing_ratio</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="mi">1013</span><span class="p">,</span> <span class="mi">270</span><span class="p">,</span> <span class="n">height</span><span class="p">)</span>
        
        <span class="c1"># Then the relative humidity using qsat</span>
        <span class="n">rH</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">q</span><span class="o">/</span><span class="n">qsat</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="c1"># Correct lapse rates where rH==100% (moist adiabatic lapse rate)</span>
        <span class="n">Gamma</span><span class="p">[</span><span class="n">rH</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.006</span>
        
    <span class="c1"># Return results    </span>
    <span class="k">return</span> <span class="n">theta</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">qsat</span><span class="p">,</span> <span class="n">rH</span><span class="p">,</span> <span class="n">cov</span><span class="p">,</span> <span class="n">adv</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Nx</span><span class="o">*</span><span class="n">dx</span><span class="p">,</span> <span class="n">dx</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">Nz</span><span class="o">*</span><span class="n">dz</span><span class="p">,</span> <span class="n">dz</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Base run</span>
<span class="n">theta0</span><span class="p">,</span> <span class="n">q0</span><span class="p">,</span> <span class="n">qsat0</span><span class="p">,</span> <span class="n">rH0</span><span class="p">,</span> <span class="n">cov0</span><span class="p">,</span> <span class="n">adv0</span><span class="p">,</span> <span class="n">c0</span><span class="p">,</span> <span class="n">d0</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">z0</span> <span class="o">=</span> <span class="n">boundary_layer_evolution_moisture_gamma</span><span class="p">(</span><span class="n">u</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">K</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> 
                                                                    <span class="n">dx</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">dz</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> 
                                                                    <span class="n">Nx</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span> <span class="n">Nz</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">hours</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create 2D plot for the covariance</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">make_plot</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Temperature&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;K&#39;</span><span class="p">,</span> 
               <span class="n">xlab</span><span class="o">=</span><span class="s1">&#39;Distance [km]&#39;</span><span class="p">,</span> <span class="n">zlab</span><span class="o">=</span><span class="s1">&#39;Height [m]&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;RdBu_r&#39;</span><span class="p">)</span>

<span class="c1"># Create 2D plot for the covariance</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">make_plot</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Mixing ratio&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;g kg$^{-1}$&#39;</span><span class="p">,</span> 
               <span class="n">xlab</span><span class="o">=</span><span class="s1">&#39;Distance [km]&#39;</span><span class="p">,</span> <span class="n">zlab</span><span class="o">=</span><span class="s1">&#39;Height [m]&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;YlGnBu&#39;</span><span class="p">)</span>

<span class="c1"># Create 2D plot for the covariance</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">make_plot</span><span class="p">(</span><span class="n">qsat</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Saturation mixing ratio&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;g kg$^{-1}$&#39;</span><span class="p">,</span> 
               <span class="n">xlab</span><span class="o">=</span><span class="s1">&#39;Distance [km]&#39;</span><span class="p">,</span> <span class="n">zlab</span><span class="o">=</span><span class="s1">&#39;Height [m]&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;YlGnBu&#39;</span><span class="p">)</span>

<span class="c1"># Create 2D plot for the covariance</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">make_plot</span><span class="p">(</span><span class="n">rH</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">z</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Relative humidity&#39;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;%&#39;</span><span class="p">,</span> 
               <span class="n">xlab</span><span class="o">=</span><span class="s1">&#39;Distance [km]&#39;</span><span class="p">,</span> <span class="n">zlab</span><span class="o">=</span><span class="s1">&#39;Height [m]&#39;</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;YlGnBu&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span><span class="n">rH</span><span class="p">,</span><span class="n">levels</span><span class="o">=</span><span class="p">[</span><span class="mf">0.95</span><span class="p">,</span><span class="mf">1.0</span><span class="p">],</span><span class="n">colors</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "sauterto/climate_modelling",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "env"
        },
        kernelOptions: {
            kernelName: "env",
            path: "./docs"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'env'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Tobias Sauter<br/>
  
      &copy; Copyright 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>